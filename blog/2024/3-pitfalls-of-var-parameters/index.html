<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cmp.osano.com/Azyw2OSBbVi7Vru2/02935cff-0b21-412a-a3c9-350aae41b81e/osano.js"></script>

<title>3 Pitfalls of Var Parameters</title>
<meta name="description"
    content="I believe I don’t have to introduce the purpose of var in procedure parameters too much. If the parameter has a var modifier, it’s passed by reference, and a...">

<meta property="og:title" content="3 Pitfalls of Var Parameters" />
<meta property="og:description"
    content="I believe I don’t have to introduce the purpose of var in procedure parameters too much. If the parameter has a var modifier, it’s passed by reference, and a..." />
<meta property="og:url" content="https://tine.staric.net/blog/2024/3-pitfalls-of-var-parameters/" />
<meta property="og:site_name" content="Tech Adventures in Business Central" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://github.com/tinestaric/tinestaric.github.io/raw/master/source/images/logo.png" />
<meta property="twitter:image" content="https://github.com/tinestaric/tinestaric.github.io/raw/master/source/images/logo.png" />

<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="https://tine.staric.net/blog/2024/3-pitfalls-of-var-parameters/">
<link rel="alternate" type="application/rss+xml" title="Tech Adventures in Business Central"
    href="https://tine.staric.net/feed.xml" />

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YMNY6X1CB8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YMNY6X1CB8');
</script>

</head>
<body>
  <header class="site-header">
  <div class="container">
    <input type="checkbox" id="toggleNavbar">
    <h1 class="logo"><a href="/">Tech Adventures in Business Central</a></small></h1>
    <label for="toggleNavbar" role="button" class="toggle-navbar-button">
      <i class="icon icon-menu"></i>
      <i class="icon icon-cross"></i>
    </label>
    <nav class="navbar">
      <ul>
        <li><a href="/" title="Home">Home</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
          <li><a href="/blog" title="Blog">Blog</a></li>
        
          <li><a href="/presentations" title="Presentations">Presentations</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-rss"></i></a></li>
      </ul>
    </nav>
  </div>
</header>


<main class="main-container">
  <div class="container">
    <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">3 Pitfalls of Var Parameters</h1>
      <em class="post-meta">
        <time>Jan 10, 2024</time>
      </em>
    </header>

    <div class="post-content">
      <p>I believe I don’t have to introduce the purpose of <strong>var</strong> in procedure parameters too much. If the parameter has a var modifier, it’s passed <strong>by reference</strong>, and any changes within the procedure will affect the variable that was passed into the procedure. If it doesn’t, it’s passed <strong>by value</strong>, meaning that any changes will stay local to that procedure. However, that’s not always the case. There are a couple of edge cases when it comes to var parameters, and as I was about to write the explanation for our internal learning purposes anyway, I decided to use this as an opportunity to make a debut in the world of blogging.</p>

<hr />

<h3 id="parameters-that-are-always-passed-by-reference">Parameters that are always passed by reference</h3>
<p>Recently I had a younger colleague struggle with passing a parameter to a function by reference. Now this wasn’t your average “you forgot a var somewhere in the signature”, but rather a List that was being passed in. The List parameter was not marked as var, yet <strong>all the changes applied within the procedure also affected the instance of a List outside the procedure</strong>.</p>

<p><em>Wait what? How come?</em></p>

<p>Well, a list, unlike your ordinary texts, integers or Booleans is a <strong>reference type</strong>, which means assigning it to a new variable or passing it to a method without var will create a separate variable that <strong>writes to the same list</strong>.</p>

<p><img src="/images/var-param-list.png" alt="List value assignment when passed without var" /></p>

<p>It’s actually quite well documented in the <a href="https://learn.microsoft.com/en-us/dynamics365/business-central/dev-itpro/developer/methods-auto/list/list-data-type">docs</a>:</p>

<p><img src="/images/var-param-list-doc.png" alt="List pass-by-reference documentation" /></p>

<p>But we’re so used to the distinction that a non-var parameter is passed by value and we can manipulate it however we like, while var parameters are passed by reference, and changes will have an effect outside of the procedure.</p>

<p>And Lists are not alone, there are a couple of data types that are always passed <strong>by reference</strong>:</p>
<ul>
  <li>Dictionary</li>
  <li>JsonObject</li>
  <li>JsonArray</li>
  <li>JsonValue</li>
  <li>JsonToken</li>
  <li>OutStream</li>
  <li>InStream</li>
  <li>Codeunit</li>
  <li>Interface</li>
  <li>ErrorInfo</li>
  <li>Notification</li>
  <li>Query</li>
  <li>TextBuilder</li>
</ul>

<p><strong>Be careful</strong> with these data types, you might get them back in a different state when the procedure finishes. This is especially true for <strong>exposing them through events</strong>, as we have no control if a subscriber can change the contents of the variable or not.</p>

<p>Var modifiers don’t make a difference, but you should still use them to <strong>signal the intentionality</strong> of your procedure. If the procedure intends to modify the parameter, add a var in front of it, if it’s only reading data, skip it.</p>

<hr />

<h3 id="temporary-records">Temporary records</h3>
<p>If we do an Insert on a normal record, we write to the database. If the table is temporary, the record is only stored in memory. <em>Easy enough</em>. However, be careful when you’re creating methods that expect temporary records. As it turns out, if the parameter is a record that is passed by reference (has a var modifier), then <strong>the “temporary” modifier has no effect</strong>.</p>

<p>If you have a procedure that takes in a Customer record by reference and is marked as temporary:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">procedure</span> <span class="nf">MyProcedure</span><span class="p">(</span><span class="kt">var</span> <span class="n">Customer</span><span class="p">:</span> <span class="n">Record</span> <span class="n">Customer</span> <span class="n">temporary</span><span class="p">)</span>
</code></pre></div></div>

<p>If you pass a non-temporary Customer record in, the record will <strong>remain non-temporary</strong>, and any record operations that MyProcedure is doing will actually make changes to the database.</p>

<p>Here’s how the records behave:</p>

<p><img src="/images/var-param-temp-all.png" alt="IsTemporary behavior depending on var and temporary parameter modifiers" /></p>

<p>If your procedures are making any <strong>dangerous operations</strong> on a pass-by-reference record, like <strong>DeleteAll</strong>, I highly suggest adding an <strong>IsTemporary gatekeeper</strong> at the beginning, either exiting or throwing a record if the record is not temporary.</p>

<p>Again, even though the temporary modifier does not affect the execution, keep using it for <strong>signaling intentionality</strong>. Are you expecting a temporary record? Mark the parameter as temporary.</p>

<hr />

<h3 id="streams-and-blobs">Streams and Blobs</h3>
<p>Short fact, <strong>streams don’t hold data, blobs hold data</strong>. So if you’re trying to read information with a stream from a blob that no longer exists (because it was de-allocated from memory), the stream won’t have anything to read from.</p>

<p><em>Okay, but what does that have to do with passing parameters around by reference?</em></p>

<p>Well, let’s take a look at this simple example.</p>

<p><img src="/images/var-param-stream-bad.png" alt="Read from a local blob with InStream" /></p>

<p>We have a blob that holds» Hello World« text, and that’s what we should be able to read with an InStream. This is another example of <em>» This should work, why doesn’t this work?«</em>.</p>

<p>And no, the answer is not <em>» because InStream is not passed by reference«</em>. As per our first point, streams are <strong>always passed by reference.</strong></p>

<p>Again, <strong>streams don’t hold data</strong>. You can think of streams as straws we use to drink. If you try to drink from a full cup, well, that will work, you’ll drink. But now I’ll take your cup, throw it away, and ask you to take another sip. <em>You can’t, can you?</em> And that’s exactly what’s happening in the above example.</p>

<p>In the ImportFile procedure, we take our cup (Temp Blob), pour in a nice cold <em>Hello World</em>, and put in the straw we got as a parameter. But now as the procedure finishes, the local variables from our procedure get <strong>de-allocated from memory</strong>. As TempBlob is one of our local variables, we’re now effectively left without our cup, drawing air through our straw, feeling sad.</p>

<p>These two options on the other hand will work just fine:</p>

<p><img src="/images/var-param-stream-global.png" alt="Reading from a global blob with InStream" /></p>

<p><img src="/images/var-param-stream-param.png" alt="Reading from a parameter blob with InStream" /></p>

<p>This time, as TempBlob is <strong>not a local variable</strong>, it doesn’t get de-allocated, and the InStream can successfully read data from it. So just keep in mind, that <strong>data source needs to still be available when you try to read from it</strong> with an InStream, either as a global variable or by being passed as a parameter.</p>

<p>Note: <strong>UploadIntoStream</strong> works just fine, as the uploaded file is allocated outside of procedure scope:</p>

<p><img src="/images/var-param-stream-upload.png" alt="Read from UploadToInStream function with InStream" /></p>


    </div>
  </div>

</article>

  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="https://github.com/tinestaric" target="_blank" rel="me"><i class="icon icon-github"></i></a></li>
  <li><a href="https://twitter.com/TineStaric" target="_blank" rel="me"><i class="icon icon-twitter"></i></a></li>
  <li><a href="https://linkedin.com/in/tstaric" target="_blank" rel="me"><i class="icon icon-linkedin"></i></a></li>
</ul>
    <p class="txt-medium-gray">
      <small>&copy;2024 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


</body>
</html>

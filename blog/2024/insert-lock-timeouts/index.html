<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cmp.osano.com/Azyw2OSBbVi7Vru2/02935cff-0b21-412a-a3c9-350aae41b81e/osano.js"></script>

<title>Curious case of Insert Lock Timeouts</title>
<meta name="description"
    content="I’ve been a BC dev for a while now. It’s been a learning experience through and through. But there was always an area that I kept pushing away. SQL. I don’t ...">

<meta property="og:title" content="Curious case of Insert Lock Timeouts" />
<meta property="og:description"
    content="I’ve been a BC dev for a while now. It’s been a learning experience through and through. But there was always an area that I kept pushing away. SQL. I don’t ..." />
<meta property="og:url"
    content="https://tine.staric.net/blog/2024/insert-lock-timeouts/" />
<meta property="og:site_name" content="Tech Adventures in Business Central | AL Development & AI Solutions" />
<meta property="og:type" content="website" />
<meta property="og:image"
    content="https://tine.staric.net/images/insertlocks/main.jpeg" />
<meta property="twitter:image"
    content="https://tine.staric.net/images/insertlocks/main.jpeg" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "name": "Tech Adventures in Business Central | AL Development & AI Solutions",
  "url": "https://tine.staric.net/blog/2024/insert-lock-timeouts/",
  "description": "I’ve been a BC dev for a while now. It’s been a learning experience through and through. But there was always an area that I kept pushing away. SQL. I don’t really know why, I never had issues with it, so I guess in my mind I just pushed it away as unimportant. It sat in some distant pile with permissions, tooltips, and translations — my afterthought pile.",
  "keywords": "tech, technology, blog, azure, devops, dynamics, nav, business central, d365, mvp, bc, AL",
  "inLanguage": "en",
  "headline": "Curious case of Insert Lock Timeouts",
  "datePublished": "2024-03-08T10:00:00+02:00",
  "dateModified": "2024-03-08T10:00:00+02:00",
  "author": {
    "@type": "Person",
    "name": "Tine Starič",
    "jobTitle": "Software Architect at Companial and a Microsoft MVP for Business Applications",
    "url": "https://tine.staric.net",
    "image": "https://tine.staric.net/images/author.jpg",
    "description": "Homebrewer, not a hipster. A Business Central enthusiast, with a passion for all things weird with AL.",
    "sameAs": [
      "https://github.com/tinestaric",
      "https://twitter.com/TineStaric",
      "https://linkedin.com/in/tstaric"
    ]
  }
}
</script>

<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="https://tine.staric.net/blog/2024/insert-lock-timeouts/">
<link rel="alternate" type="application/rss+xml" title="Tech Adventures in Business Central | AL Development & AI Solutions"
    href="https://tine.staric.net/feed.xml" />
<link rel="alternate" href="https://tine.staric.net/blog/2024/insert-lock-timeouts/" hreflang="en" />

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YMNY6X1CB8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YMNY6X1CB8');
</script>

</head>
<body>
  <header class="site-header">
  <div class="container">
    <input type="checkbox" id="toggleNavbar">
    <h1 class="logo"><a href="/">Tech Adventures in Business Central</a></small></h1>
    <label for="toggleNavbar" role="button" class="toggle-navbar-button">
      <i class="icon icon-menu"></i>
      <i class="icon icon-cross"></i>
    </label>
    <nav class="navbar">
      <ul>
        <li><a href="/" title="Home">Home</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
          <li><a href="/blog" title="Blog">Blog</a></li>
        
          <li><a href="/presentations" title="Presentations">Presentations</a></li>
        
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-rss"></i></a></li>
      </ul>
    </nav>
  </div>
</header>


<main class="main-container">
  <div class="container">
    <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">Curious case of Insert Lock Timeouts</h1>
      <em class="post-meta">
        <time>Mar 8, 2024</time>
      </em>
    </header>

    <div class="post-content">
      <p>I’ve been a BC dev for a while now. It’s been a learning experience through and through. But there was always an area that I kept pushing away. <strong>SQL</strong>. I don’t really know why, I never had issues with it, so I guess in my mind I just pushed it away as unimportant. It sat in some distant pile with <em>permissions, tooltips, and translations</em> — <strong><em>my afterthought pile.</em></strong></p>

<p>This meant I never really understood <strong>indexes, database locks, or SIFTs</strong>. And I didn’t need to. There are <strong>no locking issues</strong> when you’re testing with <strong>just one user</strong>. Well fast forward a few years, and that all had to change.</p>

<hr />

<p>For the better part of last year, I was working on a project where we were trying to analyze the <strong>performance of a huge monolithic app</strong> (3k+ objects). There were many sides we tried attacking the problem from, AL Profiler, Telemetry, BCPT,… Ultimately, we decided that our first focus should be on <strong>removing locks</strong> as the app is planned to be used by <strong>100+ concurrent users</strong> and a ton of background services.</p>

<p>We set up <strong>BCPT tests</strong>, start running them, and find our first batch of <strong>deadlocks</strong> and <strong>lock timeouts</strong>.</p>

<p><em>Time to figure out how locks work.</em> I knew we got <strong>ReadIsolation</strong> a while ago that supposedly helps with locks. I came across a couple of brilliant blog posts by <a href="https://www.linkedin.com/in/alexander-drogin-0635422b/">Alexander Drogin</a>. They helped me understand what locks are and how read isolation changes them. That’s <strong>not what I’m going to focus on here</strong>, but if you’re interested in that, here are the links: <a href="https://www.keytogoodcode.com/post/transaction-isolation-in-business-central">Transaction Isolation in Business Central</a>, <a href="https://www.keytogoodcode.com/post/readcommitted-isolation-in-azure-sql">ReadCommitted Isolation in Azure SQL</a>, <a href="https://www.keytogoodcode.com/post/read-committed-snapshot-isolation-and-the-write-skew-anomaly">ReadCommittedSnapshotIsolation and the Write Skew Anomaly</a>.</p>

<p>Some changes to <em>read isolation</em>, some <em>missing filters added</em> and some <em>write transactions started later in the process</em>, and we made our first progress. No locks on 100 concurrent users! Okay, add another scenario, rinse, and repeat.</p>

<hr />

<p>Everything seemed fine for a while until we added 5 or 6 scenarios to run concurrently. Then something extremely weird started happening. We got <strong>lock timeouts</strong>, but not on reads but <strong>on writes</strong>. That broke my mind. <strong>How am I blocked from inserting a record?</strong> I’d get modify, but insert? How can a different transaction meddle with inserts?</p>

<p><img src="/images/insertlocks/error-list.png" alt="List of lock timeout errors" /></p>

<p><em>“We can’t save your changes right now, because a record in table ‘Simple Entry’ is being updated in a transaction done by another session. You’ll have to wait until the other transaction has completed, which may take a while. Please try again later.”</em></p>

<p>This is where the call stack breaks:</p>

<p><img src="/images/insertlocks/callstack-break.png" alt="Call Stack Break Point" /></p>

<p>Now you’re probably thinking <em>“Ha! You must have some weird logic on OnInsert trigger or a subscriber!”</em>. Yeah, I thought that too. I removed <strong>all trigger, all subscribers, all global database subscribers</strong>, and nothing, still the same issue…</p>

<p>The answer was staring me <em>right in the face</em>. Here’s how the <strong>locks look after an insert</strong> to my SimpleEntry table.</p>

<p><img src="/images/insertlocks/active-locks.png" alt="Active Locks After Insert" /></p>

<p>Due to my lack of knowledge of <strong>what is SIFT</strong> and how it works, my mind dismissed it as <em>“huh, that’s odd, anyway, moving on.”</em>. But seeing the locks enough times, I decided maybe it finally is time to properly learn about SIFT.</p>

<p>If you’re comfortable with understanding SIFT, feel free to skip to the section about SIFT Locks where we continue the lock story. For everyone else, let’s take a detour, and understand <strong>what SIFTs are</strong> first.</p>

<hr />

<h3 id="sift-in-a-nutshell">SIFT in a nutshell</h3>

<p>SIFT stands for <strong>SumIndexField Technology</strong>. The <a href="https://learn.microsoft.com/en-us/dynamics365/business-central/dev-itpro/developer/devenv-sift-technology">documentation</a> could honestly do a better job of explaining the concept. Here’s how it works:</p>

<p>Imagine we have a simple table, like our <strong>SimpleEntry</strong> table. Nothing special, a primary key, a couple of fields, that’s it.</p>

<p><img src="/images/insertlocks/simple-entry-table.png" alt="Simple Entry Table" /></p>

<p>And say we have some data in there:</p>

<p><img src="/images/insertlocks/simple-entry-data.png" alt="Simple Entry Data" /></p>

<p>Now let’s say we want to figure out the total amount of sales entries. We’d do something like this:</p>

<p><img src="/images/insertlocks/sum-sales-org.png" alt="Sum Sales Procedure" /></p>

<p>Or also common, something like this</p>

<p><img src="/images/insertlocks/flowfield.png" alt="Sales Amount FlowField" /></p>

<p>In both cases, the SQL server goes through all lines of type sales and starts calculating <em>125 + 642 + … = <strong>1491!</strong></em></p>

<p>But if you define <strong>SumIndexFields</strong> on a particular key like:</p>

<p><img src="/images/insertlocks/sift-on-key.png" alt="SIFT on Key" /></p>

<p>The SQL server will start maintaining something called an <strong>Indexed View</strong>. You can think of it as another table, where sums for this key are stored. For our example, it would look like this:</p>

<p><img src="/images/insertlocks/indexed-view.png" alt="Indexed View Data" /></p>

<p>Every time an <strong>entry is added or modified in the SimpleEntry table, the sum in this <em>“table”</em> is updated as well</strong>. This means that the next time you ask for a <strong>total amount of Sale type</strong> entries, the SQL server can just go <strong><em>“1491!”</em></strong> without looping through each record.</p>

<hr />

<h3 id="turns-out-sift-is-the-culprit">Turns out SIFT is the culprit!</h3>
<p>We mentioned that if <strong>SQL maintains an indexed view</strong>, it has to <strong>update that view for each change in the underlying table</strong>. That means, that if I <strong>insert a new record</strong> into my SimpleEntry table, <strong>two rows become locked</strong>; the newly created entry record, and the row in the indexed view.</p>

<p><img src="/images/insertlocks/indexed-view-lock.png" alt="Indexed View Locks" /></p>

<p>And the lock is held for the <strong>duration of the transaction</strong>.</p>

<p>If a <strong>separate transaction</strong> tries to <strong>add a record of type Sale</strong> to the entry table, that in itself shouldn’t be a problem for the SimpleEntry table. However, as that insert needs to also update the Indexed View, it will have to <strong>wait until the first transaction releases the lock on it</strong>.</p>

<p>A record of type <strong>Purchase</strong> however will have <strong>no issues</strong>, as it doesn’t need the Sale row in the indexed view.</p>

<p><img src="/images/insertlocks/indexed-view-purchase.png" alt="Indexed View Purchase" /></p>

<p>When these transactions pile up, as they do when you have <strong>100 concurrent users</strong>, you quickly reach the <strong>10-second limit</strong> at which point the waiting transaction <strong>times out</strong>.</p>

<p>And that’s not the only side that can cause issues. Remember, anytime we <strong>lock the related row</strong> in the indexed view, we <strong>can’t insert a record</strong> in the entry table with a matching index value. The two examples above that make use of indexed views, the <em>SumSales</em> procedure and the <em>SalesAmount</em> flow field, are both <strong>reading the indexed view</strong>. So if they read it with <strong>UpdLock</strong>, which is the default locking type, after you start a write transaction, you’re going to <strong>have a problem</strong>. That is until <strong>tri-state locking</strong> becomes the default. You can read what <a href="https://www.linkedin.com/in/duilio-tacconi-4042999a">Duilio Tacconi</a> wrote <a href="https://duiliotacconi.com/2023/11/23/461/">about it</a> if you’d like to know more.</p>

<p>But until we have tri-state locking, both of these examples will effectively <strong>lock the row in our indexed view</strong>, and while the locks are held, <strong>inserts will have to wait</strong>:</p>

<p><img src="/images/insertlocks/update-and-lock-sum-sales.png" alt="Update and Lock - Sum Sales" /></p>

<p><img src="/images/insertlocks/update-and-lock-flowfield.png" alt="Update and Lock - FlowField" /></p>

<p>Yes, <strong>flow fields also lock rows</strong>. They lock them with the <strong>same lock type as the parent table</strong>. So in the above example, if I’d set the IsolationLevel on the Customer to ReadUncommited, then the flow field would apply this hint as well.</p>

<hr />

<h3 id="so-what-should-we-do-about-it">So what should we do about it?</h3>
<p><em>Should we stop using SIFT?</em> <strong>No!</strong> Well, maybe. Sometimes. It depends. There are a couple of different approaches we took to resolve our insert lockouts.</p>
<ul>
  <li><strong>Lower read isolation</strong> on reads that were reading the indexed view with <strong>UpdLock</strong>.</li>
  <li>Keep the table as is, change the logic of the process so it <strong>inserts in the TempTable</strong> first, and only inserts in the actual table at the very end, <strong>holding locks for a minimal time</strong>.</li>
  <li>Run the processes <strong>asynchronously</strong> through a job queue entry</li>
  <li>Switch user inserts to a staging table that’s <strong>optimized for inserting</strong> and have a job transfer data to <strong>read optimized tables</strong>.</li>
  <li><strong>Remove SumIndexFields</strong> and accept the read performance penalty</li>
</ul>

<p>There’s another one, that we haven’t tried. Just the other day, I was watching <a href="https://www.linkedin.com/in/ericwauters">Waldo’s</a> <a href="https://youtu.be/E3ADZsisFbE?si=mPtH-c2A8hO0sYhA&amp;t=1003">Coding 4 Performance</a> session from <a href="https://www.bctechdays.com/event">BC Tech Days</a> where he mentions <strong>IncludedFields</strong> as an alternative to SIFT. That’s another option to look into.</p>

<p>As you see, it’s not a simple answer, there are different options, all coming with their own <strong>set of tradeoffs</strong>, but at least I hope the next time you experience issues with <strong>locks on inserts</strong>, you’ll know where to look.</p>


    </div>
  </div>

</article>

  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="https://github.com/tinestaric" target="_blank" rel="me"><i class="icon icon-github"></i></a></li>
  <li><a href="https://twitter.com/TineStaric" target="_blank" rel="me"><i class="icon icon-twitter"></i></a></li>
  <li><a href="https://linkedin.com/in/tstaric" target="_blank" rel="me"><i class="icon icon-linkedin"></i></a></li>
  <li><a href="https://bsky.app/profile/tinestaric.bsky.social" target="_blank" rel="me"><svg xmlns="http://www.w3.org/2000/svg" width="1.6em" height="1.6em" fill="currentColor" class="icon" viewBox="0 0 16 16"><path d="M3.468 1.948C5.303 3.325 7.276 6.118 8 7.616c.725-1.498 2.698-4.29 4.532-5.668C13.855.955 16 .186 16 2.632c0 .489-.28 4.105-.444 4.692-.572 2.04-2.653 2.561-4.504 2.246 3.236.551 4.06 2.375 2.281 4.2-3.376 3.464-4.852-.87-5.23-1.98-.07-.204-.103-.3-.103-.218 0-.081-.033.014-.102.218-.379 1.11-1.855 5.444-5.231 1.98-1.778-1.825-.955-3.65 2.28-4.2-1.85.315-3.932-.205-4.503-2.246C.28 6.737 0 3.12 0 2.632 0 .186 2.145.955 3.468 1.948"/></svg></a></li>
</ul>
    <p class="txt-medium-gray">
      <small>&copy;2025 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


</body>
</html>
